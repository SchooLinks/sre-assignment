# Overview
These are notes related to my solution. A place for me to keep track of issues and problems I have to solve related to the project.

# Plan
## Work through the "Getting Started" section
The following were some issues encountered while running through the "Getting Started" section.
### Made edits to the README.md due to the `pipenv install` line being confusing.
It wanted me to install the dependencies, not install pipenv.
### Had to install pipenv via instructions on https://pipenv.pypa.io/en/latest/
Had to use `pip install pipenv` instead of the `pip install -user pipenv` because I was installing in a venv created by pyenv.
### Created a docker-compose.yml to provision a local mysql
- Ran `docker-compose up -d --build` to build the mysql server container
- Ran `DATABASE_HOST=127.0.0.1 pipenv run python schoolapp/manage.py migrate`. Had to override the `DATABASE_HOST` because using `localhost` tries connecting via sockets rather than tcp.
### Attempting access once the server was running produced a 400 response.
- Response was `Invalid HTTP_HOST header: '127.0.0.1:8000'. You may need to add '127.0.0.1' to ALLOWED_HOSTS.`
- Adding "127.0.0.1" to the ALLOWED_HOSTS in the `setting.py` allowed access.
### Successfully connected to the admin after creating a user.
After creating a user and getting a better understanding of the project, I moved on to working on the "Requirments".

## Work through "Requirements"
After some analysis paralysis, I decided to go with building out the docker-compose.yml to spin up the database and django app. Once that is working, I'll create an AWS CDK project to create an EC2 instance in the free tier with docker-compose installed. When the instance is created, the code can be copied to the instance and deployed using `docker-compose`.

### Development Requirements
- Docker-compose installed for running the application locally.
- AWS CDK: https://docs.aws.amazon.com/cdk/v2/guide/getting_started.html

### Docker Compose commands
These can be run locally or on the infrastructure after the code is copied to it.
- Build the images: `docker-compose build`
- Start the services: `docker-compose up -d`
- Run migrations: `docker-compose run schoolapp pipenv run python manage.py migrate`
- Create an admin user: `docker-compose run schoolapp pipenv run python manage.py createsuperuser`
- (Local Only) Open a browser to the following site: `http://localhost:80`

### AWS CDK commands
After your AWS CDK environment is setup, use the following commands in the `schoolapp-cdk` directory to develop and deploy the AWS infrastructure:
- Run cdk tests: `npm test`
- See changes to the cdk infrastructure: `cdk diff`
- Deploy cdk infrastructure: `cdk deploy`
- Destroy cdk infrastructure: `cdk destroy`

### Deployment Instructions
Use the following instructions to create the infrastructure and deploy the app:
1. Change directory to the `schoolapp-cdk` directory: `cd schoolapp-cdk`
1. Deploy the CDK code: `cdk deploy`
1. Take note of the outputs generated by the CDK deploy. They are used in the following steps.
1. Get the `.pem` file frome parameter store: `aws --region=us-east-1 ssm get-parameter --name "/ec2/keypair/<KEYPAIR_ID>" --with-decryption --output text --query Parameter.Value > <KEYPAIR_ID>.pem`
1. Using the downloaded keypair and the ip address in the CDK output, copy the `src` directory to the instance using scp: `scp -r -i <KEYPAIR_PEM_FILE> src ec2-user@<IP_OF_INSTANCE>:.`
1. Login to the instance using ssh: `ssh -i <KEYPAIR_PEM_FILE> ec2-user@<IP_OF_INSTANCE>`
1. Start the services: `docker-compose up -d`
1. Run migrations: `docker-compose run schoolapp pipenv run python manage.py migrate`
1. Create an admin user: `docker-compose run schoolapp pipenv run python manage.py createsuperuser`

Once all those commands are successful, the app should be accessable through a browser using the IP address of the instance.

### Possible Improvements
- Add running the migrations as part of the app Dockerfile.
- Create a script to grab the keypair and deploy the code to the instance created by the CDK code.
- For a more robust solution, I would probably implement something similar to this blog post: https://betterprogramming.pub/deploy-your-django-apps-in-aws-with-cdk-v2-997731a4aa50
